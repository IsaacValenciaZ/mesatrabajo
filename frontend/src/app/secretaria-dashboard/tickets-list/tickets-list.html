<div class="view-section fade-in">
  
  <div class="section-header">
    <div>
      <h1>Historial de Reportes</h1>
      <p>Consulta tus tickets organizados por mes.</p>
    </div>
    
    <div class="filters-container" style="position: relative;"> 
        <select class="month-select" [(ngModel)]="mesSeleccionado" (change)="aplicarFiltroMes()">
            <option *ngFor="let m of mesesDisponibles" [value]="m">{{ obtenerNombreMes(m) }}</option>
            <option *ngIf="mesesDisponibles.length === 0" value="" disabled>Sin registros</option>
        </select>

        <button class="btn-summary" (click)="toggleCalendario()" title="Seleccionar Día">
            <span class="material-symbols-outlined">calendar_month</span>
        </button>

        <button class="btn-summary" (click)="verResumenMensual()" title="Ver Gráficas del Mes">
             <span class="material-symbols-outlined">bar_chart</span>
        </button>

        <div class="calendar-popup fade-in" *ngIf="mostrarCalendario && diasCalendario.length > 0">
            <div class="calendar-wrapper">
                <div class="calendar-header">
                    <span>Dom</span><span>Lun</span><span>Mar</span><span>Mié</span><span>Jue</span><span>Vie</span><span>Sáb</span>
                </div>
                <div class="calendar-grid">
                    <div *ngFor="let d of diasCalendario" class="calendar-day" 
                         [ngClass]="{'empty': !d.dia, 'has-tickets': d.tieneTickets, 'selected': d.dia === diaSeleccionado, 'no-tickets': d.dia && !d.tieneTickets}"
                         (click)="seleccionarDia(d)">
                         <span *ngIf="d.dia">{{ d.dia }}</span>
                         <div *ngIf="d.tieneTickets" class="dot-indicator"></div>
                         <div *ngIf="d.dia && !d.tieneTickets" class="empty-mark">-</div>
                    </div>
                </div>
                <div class="calendar-legend">
                    <small *ngIf="diaSeleccionado" (click)="seleccionarDia({dia: diaSeleccionado})" style="cursor: pointer; color: #56212f; font-weight: bold; text-decoration: underline;">Mostrar todo el mes</small>
                    <small *ngIf="!diaSeleccionado">Selecciona un día</small>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div *ngIf="gruposPorDia.length === 0 && !cargando" class="empty-general">
      <div class="empty-state">No hay reportes para el período seleccionado.</div>
  </div>

  <div *ngFor="let grupo of gruposPorDia" class="day-group fade-in">
      <div class="date-divider">
          <div class="left-info">
              <span class="date-text">{{ grupo.fecha | date:'fullDate' | titlecase }}</span>
              <span class="count-badge">{{ grupo.tickets.length }} reportes</span>
          </div>
          <button class="btn-stats" (click)="verEstadisticasDia(grupo)" title="Ver Gráficas del Día">
             <span class="material-symbols-outlined">donut_large</span>
          </button>
      </div>

      <div class="table-card">
        <div class="table-responsive">
          <table class="simple-table">
            <thead>
              <tr>
                <th>Hora</th>
                <th>Solicitante</th>
                <th>Depto</th>
                <th>Técnico</th>
                <th>Problema</th>
                <th>Prioridad</th>
                <th>Notas</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let t of grupo.tickets">
                <td class="time-col">{{ t.fecha | date:'hh:mm a' }}</td>
                <td><strong>{{ t.nombre_usuario }}</strong></td>
                <td class="depto-col">{{ t.departamento }}</td>
                <td>{{ t.personal }}</td>
                
                <td>
                    <span class="badge" [ngClass]="{
                        'cat-internet': t.descripcion === 'Internet', 
                        'cat-office': t.descripcion === 'Office', 
                        'cat-telefonia': t.descripcion === 'Telefonia', 
                        'cat-tecnico': t.descripcion === 'Tecnico',
                        'cat-dictaminar': t.descripcion === 'Dictaminar',
                        'cat-extension': t.descripcion === 'Extension/Telefono',
                        'cat-correo': t.descripcion === 'Correo'
                    }">{{ t.descripcion }}</span>
                    
                    <span *ngIf="t.descripcion === 'Dictaminar' && t.cantidad_dicta" class="qty-badge" style="margin-top: 5px; display: block;">
                        EQ: {{ t.cantidad_dicta }}
                    </span>
                    
                    <span *ngIf="t.descripcion === 'Extension/Telefono' && t.extension_tel" class="qty-badge" style="margin-top: 5px; display: block;">
                        Num: {{ t.extension_tel }}
                    </span>
    
                    <span *ngIf="t.descripcion === 'Correo' && t.correo_tipo" class="qty-badge" style="margin-top: 5px; display: block;">
                        Dom: {{ t.correo_tipo }}
                    </span>
    
                    <span *ngIf="t.descripcion === 'Tecnico' && t.soporte_tipo" class="qty-badge" style="margin-top: 5px; display: block; white-space: normal; line-height: 1.2;">
                        {{ t.soporte_tipo }}
                    </span>
                </td>

                <td>
                    <span class="badge" [ngClass]="{
                        'prio-alta': t.prioridad === 'Alta',
                        'prio-media': t.prioridad === 'Media',
                        'prio-baja': t.prioridad === 'Baja'
                    }">{{ t.prioridad }}</span>
                </td>

                <td class="msg-col">
                    <span *ngIf="t.notas.length <= 30">{{ t.notas }}</span>
                    <div *ngIf="t.notas.length > 30">
                        <span class="texto-truncado">{{ t.notas | slice:0:30 }}...</span>
                        <div class="ver-mas-container">
                            <a class="link-ver-mas" (click)="verNotaCompleta(t.notas)">Ver más</a>
                        </div>
                    </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
  </div>
</div>